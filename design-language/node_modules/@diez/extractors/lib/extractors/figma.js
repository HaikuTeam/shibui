"use strict";const e=require("@diez/cli-core"),t=require("@diez/generation"),s=require("@diez/storage"),n=require("fs-extra"),o=require("path"),i=require("url"),a=require("../utils"),r=require("../utils.network"),l="https://api.figma.com/v1",c=new Map([["COMPONENT",t.AssetFolder.Component]]),f=e=>"GRADIENT_LINEAR"===e.type,g=e=>"SOLID"===e.type,d=e=>{const t=i.parse(e);if(t&&t.pathname&&t.host&&t.host.endsWith("figma.com")){const e=t.pathname.split("/");return{id:e[2]||"",name:e[3]||"Untitled"}}return null},p=(e,t)=>r.performGetRequestWithBearerToken(`${l}/files/${e}`,t),m=async(c,f,g,d)=>{if(!c.size)return void e.Log.info("This Figma file does not contain any images (designated as Figma Components).");e.Log.info("Retrieving component URLs from the Figma API...");const p=a.chunk(Array.from(c.keys()),100),m=[],u=["1","2","3","4"];for(const e of u)for(const t of p)m.push({scale:e,ids:t.join(",")});const h=new Map(u.map(e=>[e,new Map]));await Promise.all(m.map(async({scale:e,ids:t})=>{const s=new i.URLSearchParams([["format","png"],["ids",t],["scale",e]]),n=h.get(e),{images:o}=await r.performGetRequestWithBearerToken(`${l}/images/${g}?${s.toString()}`,d);for(const[e,t]of Object.entries(o))n.set(e,t)}));const y=[];for(const[i,a]of h)for(const[r,l]of a){const a=`${c.get(r)}${"1"!==i?`@${i}x`:""}.png`;e.Log.info(`Downloading asset ${a} from the Figma CDN...`),y.push(s.downloadStream(l).then(e=>{e.pipe(n.createWriteStream(o.join(f,t.AssetFolder.Component,a)))}))}return Promise.all(y)},u=(e,s,n)=>{(e=>"DROP_SHADOW"===e.type)(e)&&n.shadows.push({name:s,initializer:(e=>t.getDropShadowInitializer({offset:e.offset,radius:e.radius,colorInitializer:h(e.color)}))(e)})},h=({r:e,g:t,b:s,a:n})=>`Color.rgba(${Math.round(255*e)}, ${Math.round(255*t)}, ${Math.round(255*s)}, ${n})`,y=e=>h(e.color),w=(e,s,n)=>{g(e)?n.colors.push({name:s,initializer:y(e)}):f(e)&&n.gradients.push({name:s,initializer:(e=>{const s=e.gradientStops.map(e=>({position:e.position,colorInitializer:h(e.color)}));return t.getLinearGradientInitializer(s,e.gradientHandlePositions[0],e.gradientHandlePositions[1])})(e)})},z=async(s,n,o,i,a,r,l)=>{if(o.size||n.size||i.size||a.size){if(l.styles&&(n.size&&l.styles.effect&&n.has(l.styles.effect)&&l.effects&&l.effects.length&&(u(l.effects[0],n.get(l.styles.effect),s),n.delete(l.styles.effect)),o.size&&l.styles.fill&&o.has(l.styles.fill)&&l.fills&&l.fills.length&&(w(l.fills[0],o.get(l.styles.fill),s),o.delete(l.styles.fill)),i.size&&l.styles.text&&i.has(l.styles.text)&&l.style)){const n=await t.locateFont(l.style.fontFamily,{name:l.style.fontPostScriptName});n?await t.registerFont(n,s.fonts):e.Log.warning(`Unable to locate system font assets for ${l.style.fontFamily}.`),s.typographs.push({name:i.get(l.styles.text),initializer:t.getTypographInitializer(s.designLanguageName,n,l.style.fontPostScriptName,l.style.fontSize,(t=>{const s=t.fills&&t.fills[0];if(s)return g(s)?y(s):f(s)&&s.gradientStops[0]?(e.Log.warning(`A linear gradient fill was found on the "${t.name}" text style which is not supported. The gradient's first stop color will be used instead.`),h(s.gradientStops[0].color)):void e.Log.warning(`An unsupported Text Style fill was found on ${t.name}. The default color will be used instead.`)})(l))}),i.delete(l.styles.text)}if(a.has(l.id)&&l.absoluteBoundingBox?(r.set(l.id,l.absoluteBoundingBox),a.delete(l.id)):l.componentId&&a.has(l.componentId)&&l.absoluteBoundingBox&&(r.set(l.componentId,l.absoluteBoundingBox),a.delete(l.componentId)),l.children)for(const e of l.children)await z(s,n,o,i,a,r,e)}},F=async(e,s,n,i)=>{const a=Object.entries(i.styles||{}),r=new Map(a.filter(([e,{styleType:t}])=>"FILL"===t).map(([e,{name:t}])=>[e,t])),l=new Map(a.filter(([e,{styleType:t}])=>"EFFECT"===t).map(([e,{name:t}])=>[e,t])),c=new Map(a.filter(([e,{styleType:t}])=>"TEXT"===t).map(([e,{name:t}])=>[e,t])),f=new Set(s.keys()),g=new Map;for(const t of i.document.children)await z(e,l,r,c,f,g,t);for(const[i,a]of s){const s=g.get(i)||{width:0,height:0};t.registerAsset({...s,src:o.join(n,t.AssetFolder.Component,`${a}.png`)},t.AssetFolder.Component,e.assets)}};module.exports=class{constructor(e=""){this.token=e}static async configure(t){let n=await s.Registry.get("figmaAccessToken");n||(e.Log.info("Figma authentication required."),n=await r.getFigmaAccessToken(),await s.Registry.set({figmaAccessToken:n})),t.push(n)}static async shouldRetryError(t){return t instanceof e.UnauthorizedRequestException&&(await s.Registry.delete("figmaAccessToken"),!0)}static create(e){return new this(e)}static async canParse(e){return null!==d(e)}async export({source:e,assets:s,code:n},i,r=a.cliReporters){if(!this.token)throw new Error("Figma requires a token in order to perform the export. Please set one (`figma.token = token`) and try again");const l=d(e);if(!l)throw new Error("Invalid source file");r.progress("Fetching information from Figma.");const f=await p(l.id,this.token),g=t.pascalCase(f.name),u=`${g}.figma`,h=o.join(s,`${u}.contents`);r.progress(`Creating necessary folders for ${u}`),await a.createFolders(h,c.values());const y=t.createDesignLanguageSpec(g,h,o.join(n,`${u}.ts`),i),w=new t.UniqueNameResolver,z=new Map(Object.entries(f.components||{}).map(([e,{name:t}])=>[e,w.getComponentName(t)]));return await F(y,z,o.relative(i,h),f),Promise.all([m(z,h,l.id,this.token),t.codegenDesignLanguage(y)])}};
//# sourceMappingURL=/@diez/extractors/lib/extractors/figma.js.map