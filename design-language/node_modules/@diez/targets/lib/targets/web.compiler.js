"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=require("@diez/cli-core"),t=require("@diez/compiler-core"),i=require("@diez/storage"),o=require("fs-extra"),s=require("handlebars"),r=require("internal-ip"),n=require("path"),a=require("../utils"),u=require("./web.api"),c=n.join(a.sourcesPath,"web"),p=(e,t)=>{for(const i of e)if(i.packageJson.name===t.packageJson.name)return;e.add(t)},l=Buffer.from("\n");class d extends t.Compiler{async validateOptions(){}async hostname(){return await r.v4()}get moduleName(){return`diez-${this.output.projectName}`}get hotComponent(){return require.resolve("@diez/targets/lib/targets/web.component")}collectComponentProperties(e,t){const i=t.filter(e=>void 0!==e),o=i[0];if(!o){const t=e.isComponent?e.type:this.getPrimitiveName(e.type);if(!t)return;return{...e,type:`${t}[]`,initializer:"[]"}}return{...o,type:`${o.type}[]`,initializer:`[${i.map(e=>e.initializer).join(", ")}]`}}getInitializer(e){const t=[];for(const i of e.properties)t.push(`${i.name}: ${i.initializer}`);return`{${t.join(", ")}}`}getPrimitiveName(e){switch(e){case t.PrimitiveType.String:return"string";case t.PrimitiveType.Float:case t.PrimitiveType.Number:case t.PrimitiveType.Int:return"number";case t.PrimitiveType.Boolean:return"boolean";default:return}}getPrimitiveInitializer(e,i){switch(e){case t.PrimitiveType.String:return`"${i}"`;case t.PrimitiveType.Float:case t.PrimitiveType.Number:case t.PrimitiveType.Int:case t.PrimitiveType.Boolean:return i.toString();default:return}}mergeBindingToOutput(e){for(const t of e.sources)this.output.sources.add(t);if(e.declarations)for(const t of e.declarations)this.output.declarations.add(t);if(e.dependencies)for(const t of e.dependencies)p(this.output.dependencies,t)}createOutput(e,t){return{sdkRoot:e,projectName:t,processedComponents:new Map,sources:new Set,declarations:new Set,declarationImports:new Set,dependencies:new Set,assetBindings:new Map,styleSheet:{variables:new Map,font:new u.RuleList,styles:new u.RuleList}}}get staticRoot(){return n.join(this.output.sdkRoot,"static")}printUsageInstructions(){const t=e.Format.code("Diez"),i=Array.from(this.parser.rootComponentNames)[0],o=this.output.styleSheet.variables.keys().next().value;e.Log.info(`Diez package compiled to ${this.output.sdkRoot}.\n`),e.Log.info(`You can depend on ${t} in ${e.Format.code("package.json")}:`),e.Log.code(`{\n  "dependencies": {\n    "${this.moduleName}": "*"\n  }\n}\n`),e.Log.info(`You can use the variables and classes defined by ${t} in your CSS or Sass styles.\n  CSS:  ${e.Format.code(`rule: var(--${o});`)}\n  Sass: ${e.Format.code(`rule: $${o};`)}\n`),e.Log.info(`You can also use ${t} with JavaScript to bootstrap any of the components defined in your project.`),e.Log.code(`new Diez(${i}).attach((component) => {\n  // ...\n});\n`)}clear(){this.output.sources.clear(),this.output.declarations.clear(),this.output.processedComponents.clear(),this.output.dependencies.clear(),this.output.assetBindings.clear(),this.output.styleSheet.variables.clear(),this.output.styleSheet.styles.clear()}getStyleTokens(){const e=new Set;for(const[t,i]of this.output.processedComponents)for(const o of i.properties){const s=o.type.toString();if(!["number","string","boolean"].includes(s)||i.binding)continue;if("Fill"===t||"Font"===t||"GradientStop"===t||"Point2D"===t||"Size2D"===t)continue;const r=a.joinToKebabCase(t,o.name);this.output.styleSheet.variables.set(r,o.initializer),"number"===s&&e.add(r)}const t=[];return this.output.styleSheet.variables.forEach((i,o)=>{t.push({name:o,value:i}),e.has(o)&&t.push(...a.getUnitedStyleSheetVariables(o,i))}),{styleVariables:t,styleFonts:this.output.styleSheet.font.serialize(),styleSheets:this.output.styleSheet.styles.serialize()}}writeStyleSdk(e,t){const i=o.readFileSync(n.join(c,`styles.${e}.handlebars`)).toString(),r=this.parser.hot?this.hotStaticRoot:this.staticRoot;o.ensureDirSync(r),o.writeFileSync(n.join(r,`styles.${e}`),s.compile(i)(t))}writeAssets(){super.writeAssets();const e=this.getStyleTokens();this.writeStyleSdk("css",e),this.writeStyleSdk("scss",e)}generateSource(){const e=[];for(const t of this.output.sources)e.push(o.readFileSync(t),l);return Buffer.concat(e)}generateDeclaration(){const e=Array.from(this.output.declarationImports).map(e=>Buffer.from(e));for(const t of this.output.declarations)e.push(o.readFileSync(t),l);return Buffer.concat(e)}async writeSdk(){const e=o.readFileSync(n.join(c,"js.component.handlebars")).toString(),r=o.readFileSync(n.join(c,"js.declaration.handlebars")).toString(),u=(await t.getAssemblerFactory("web"))(this.output);await u.addCoreFiles(),s.registerHelper("list",a.webComponentListHelper);for(const[t,{binding:n,...a}]of this.output.processedComponents){for(const e of Object.values(a.properties))e.originalType&&this.parser.getComponentForTypeOrThrow(e.originalType).isFixedComponent&&(e.initializer="{}");const u=i.getTempFileName();if(this.output.sources.add(u),o.writeFileSync(u,s.compile(e)({...a,fixed:a.isRootComponent||this.parser.getComponentForTypeOrThrow(t).isFixedComponent})),n&&this.mergeBindingToOutput(n),n&&n.declarations&&n.declarations.length)continue;const c=i.getTempFileName();this.output.declarations.add(c),o.writeFileSync(c,s.compile(r)(a))}const p={moduleName:this.moduleName,sdkVersion:this.parser.options.sdkVersion,dependencies:Array.from(this.output.dependencies)};return this.writeAssets(),Promise.all([u.writeFile(n.join(this.output.sdkRoot,"index.js"),this.generateSource()),u.writeFile(n.join(this.output.sdkRoot,"index.d.ts"),this.generateDeclaration()),i.outputTemplatePackage(n.join(c,"sdk"),this.output.sdkRoot,p)])}}exports.WebCompiler=d,exports.webHandler=(async e=>new d(e).start());
//# sourceMappingURL=/@diez/targets/lib/targets/web.compiler.js.map