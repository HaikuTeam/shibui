"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const a=require("@diez/cli-core"),n=require("@diez/storage"),t=require("change-case"),o=require("child_process"),r=require("fs-extra"),s=require("path"),i=require("tar"),c=e(require("validate-npm-package-name")),l=require("./utils.git"),m=`https://examples.diez.org/${a.diezVersion}/createproject/project.tgz`;exports.canUseNpm=(async e=>{let a=null;try{a=o.spawnSync("npm",["config","list"]).output.join("")}catch(e){return!0}if("string"!=typeof a)return!0;const n=a.match(/^; cwd = (.*)$/m);return null===n||n[1]===e});const d=async(e,o)=>{const c=s.resolve(n.getTempFileName(),"examples");r.ensureDirSync(c),await(async e=>{const t=a.loadingMessage("Downloading template project from the Diez CDN..."),o=await n.downloadStream(m);if(t.stop(),!o)throw new Error("Unable to download template project from examples.diez.org. Please try again.");const r=i.x({cwd:e});return o.pipe(r),new Promise(e=>r.on("close",e))})(c);const l=t.pascalCase(o),d={openTag:"{{",closeTag:"}}",namePascalCase:l,nameLowerCase:t.lowerCase(l),nameKebabCase:t.kebabCase(o),nameCamelCase:t.camelCase(o),nameTitleCase:t.titleCase(o),nameNoCase:t.noCase(o),nameSnakeCase:t.snakeCase(o),nameConstantCase:t.constantCase(o),nameHeaderCase:t.headerCase(o),nameDotCase:t.dotCase(o)};return n.outputTemplatePackage(c,e,d)};exports.createProject=(async(e,o,i=process.cwd())=>{(e=>{const n=c.default(e);if(!n.validForNewPackages){const t=[];throw n.errors&&t.push(...n.errors.map(e=>` - ${e}`)),n.warnings&&t.push(...n.warnings.map(e=>` - ${e}`)),t.length&&(a.Log.warning("Project name validation failed:"),a.Log.warning(...t)),new Error(`Unable to create project with name ${e}.`)}})(e);const m=await(()=>a.canRunCommand("yarnpkg --version"))(),p=s.resolve(i,s.basename(e)),u=o?p:s.join(p,"design-language");if(await(async(e,a=!1)=>{if(r.existsSync(e)&&!r.lstatSync(e).isDirectory())throw new Error(`Found a non-directory at ${e}.`);if(r.ensureDirSync(e),r.existsSync(s.join(e,"package.json")))throw new Error(`A Node.js project already exists at ${e}.`);if(!a&&!await exports.canUseNpm(e))throw new Error(`Unable to start an NPM process in ${e}.`)})(u,m),o){const o={packageName:e,diezVersion:a.diezVersion,typescriptVersion:a.devDependencies.typescript,componentName:t.pascalCase(s.basename(e))};await n.outputTemplatePackage(s.resolve(__dirname,"..","templates","project"),p,o)}else try{await d(i,e)}catch(e){throw a.Log.warning("Unable to download template project from the Diez CDN. Are you connected to the internet?"),a.Log.warning(`If you would like to generate an empty project, you can re-run this command with ${a.Format.code("--bare")}.`),e}const g=s.join(p,"example-codebases"),w=a.loadingMessage("Installing dependencies. This might take a couple of minutes.");try{await a.execAsync(`${m?"yarn":"npm"} install`,{cwd:u})}catch(e){a.Log.warning("Unable to install dependencies. Are you connected to the Internet?"),a.Log.warning(`You may need to run ${a.Format.code(`${m?"yarn":"npm"} install`)} before ${a.Format.code("diez")} commands will work.`)}w.stop();const y=[u];if(!o)for(const e of["android","ios","web"])y.push(s.join(g,e));try{for(const e of y)await l.initializeGitRepository(e),a.Log.info(`Initialized a Git repository at ${e}.`)}catch(e){}a.Log.info(`Success! Your new Diez Project has been created at ${a.Format.comment(u)}.\n\nIn that directory, the ${a.Format.code("diez")} command line utility can be invoked using:\n  ${a.Format.code(`${m?"yarn":"npm run"} diez`)}\n`),o?a.Log.info(`To see a list of available commands, you can run:\n  ${a.Format.code(`cd ${s.relative(i,u)}\n  ${m?"yarn":"npm run"} diez --help`)}`):(a.Log.info(`Example codebases demonstrating how to integrate Diez in your app have been created at ${a.Format.comment(g)}.\n\nTo get started, we suggest running:\n  ${a.Format.code(`cd ${s.relative(i,u)}\n  ${m?"yarn":"npm run"} demo`)}\n`),a.Log.info("Check out https://diez.org/getting-started to learn more."))});
//# sourceMappingURL=/@diez/createproject/lib/utils.js.map