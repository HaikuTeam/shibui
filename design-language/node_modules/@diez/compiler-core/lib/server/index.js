"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const t=require("@diez/cli-core"),o=require("chokidar"),r=e(require("cors")),n=e(require("debounce")),s=e(require("express")),i=e(require("express-handlebars")),a=require("fs-extra"),u=require("net"),c=require("path"),d=e(require("webpack")),l=e(require("webpack-dev-middleware")),p=e(require("webpack-hot-middleware")),f=require("./config");exports.serveHot=(async(e,m,g,h)=>{const q=s.default();q.set("views",c.resolve(__dirname,"..","..","views")),q.get("/components/:componentName",(e,t)=>{const{componentName:o}=e.params;t.render("component",{componentName:o,layout:!1})});const v=f.getConfiguration(e,m),b=d.default(v),w=l.default(b,{publicPath:"",logLevel:"warn"}),_=p.default(b,{log:!1}),x=c.join(e.projectRoot,".diez","extract-port"),k=o.watch(x,{useFsEvents:!1});t.exitTrap(()=>{k.close()});const L=n.default(()=>{t.Log.info("Reloading assets..."),_.publish({reload:!0})},500);k.on("add",()=>{const e=Number(a.readFileSync(x)),o=u.createConnection(e,"0.0.0.0",()=>{t.Log.info(`Receiving hot assets on port ${e}.`)});o.setEncoding("utf8"),t.socketTrap(o),o.on("data",e=>{const{event:t}=JSON.parse(e.toString());"reload"===t&&L()})}),q.use(w),q.use(_);let N="";b.hooks.done.tap("@diez/compiler-core",({hash:o,endTime:r})=>{if(o&&r&&N!==o){const n=r-e.hotBuildStartTime;t.Log.info(`Built in ${n}ms.`),process.send&&process.send("built"),N=o}}),q.use(r.default()),q.engine("handlebars",i.default()),q.set("view engine","handlebars"),q.use(s.default.static(h)),q.listen(g,()=>{t.Log.info(`Serving hot on port ${g}.`)})});
//# sourceMappingURL=/@diez/compiler-core/lib/server/index.js.map