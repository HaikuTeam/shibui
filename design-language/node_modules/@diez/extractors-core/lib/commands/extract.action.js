"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const s=require("@diez/cli-core"),r=require("@diez/compiler-core"),o=require("async"),t=require("chokidar"),c=require("fs-extra"),i=require("net"),a=require("path"),n=e(require("readline")),u=require("../utils"),d={sources:"./designs",assets:"./assets",code:"./src/designs",services:[]},l=o.queue(async(e,r)=>{try{await u.performExtraction(e,global.process.cwd());for(const s of e.sockets)s.write(JSON.stringify({event:"reload"}))}catch(e){s.Log.warning(e)}finally{r()}});module.exports=(async({hot:e})=>{const o=(await s.findPlugins()).get("."),g={...d,...o?o.designs:void 0},p=await r.getProjectRoot();g.sources=a.resolve(p,g.sources),g.assets=a.resolve(p,g.assets),g.code=a.resolve(p,g.code),c.ensureDirSync(g.sources);const f=c.readdirSync(g.sources).map(e=>a.join(g.sources,e)).concat(g.services);if(await Promise.all(f.map(async e=>{try{await u.performExtraction({source:e,assets:g.assets,code:g.code},p)}catch(e){return void s.Log.warning(e)}})),e){const e=a.join(global.process.cwd(),".diez","extract-port");if(c.existsSync(e))throw new Error(`Found existing hot extraction mutex at ${e}. If this is an error, please manually remove the file.`);const o=[],u=t.watch(g.sources,{useFsEvents:!1,ignoreInitial:!0});s.exitTrap(()=>{u.close()}),s.Log.info(`Watching ${s.Format.code(g.sources)} for changes...`),g.services.length&&s.Log.info(`Press ${s.Format.code("r")} to refresh design services...`);const d=process.stdin;d&&d.setRawMode&&(n.default.emitKeypressEvents(d),d.setRawMode(!0),d.on("keypress",(e,s)=>{if("r"===e)return l.push(g.services.map(e=>({sockets:o,source:e,assets:g.assets,code:g.code})));"c"===s.name&&s.ctrl&&process.exit()})),u.on("all",(e,s)=>{"add"!==e&&"change"!==e||l.push({sockets:o,source:s,assets:g.assets,code:g.code})});const p=await r.getHotPort(),f=i.createServer(e=>{s.socketTrap(e),o.push(e)});f.listen(p,"0.0.0.0",()=>{s.exitTrap(()=>{c.removeSync(e),f.close();for(const e of o)e.destroy();process.exit(0)}),c.writeFileSync(e,p),s.Log.info(`Serving hot assets on port ${p}.`)})}});
//# sourceMappingURL=/@diez/extractors-core/lib/commands/extract.action.js.map